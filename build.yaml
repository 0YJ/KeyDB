# Doc: https://wiki.sc-corp.net/pages/viewpage.action?pageId=121500284
version: 1
machamp:
  keydb-build:
    # Optional - build counter is linked to the build def
    tag_template: 0.0.%build.counter%
    # Optional - value in seconds before a build is terminated, default is 3600 seconds
    timeout: 3600
    # Optional - update ghe or not, default to true
    update_ghe: true
    code_coverage: false
    # Required
    steps:
      make-build:
        type: cmd
        # Dockerfile for the builder img is in https://github.sc-corp.net/Snapchat/img/tree/master/build/ubuntu/ubuntu-20-04/keydb
        builder_image: us.gcr.io/snapchat-build-artifacts/prod/snapchat/img/build/keydb-ubuntu-20-04@sha256:c8e6ecf3c8b385509cc4e0521d7e28d6eef1f70dc7ca0a29f26ec02344870c42
        command: ./machamp_scripts/build.sh
      tls-test:
        type: cmd
        parent: make-build
        # Dockerfile for the builder img is in https://github.sc-corp.net/Snapchat/img/tree/master/build/ubuntu/ubuntu-20-04/keydb
        builder_image: us.gcr.io/snapchat-build-artifacts/prod/snapchat/img/build/keydb-ubuntu-20-04@sha256:c8e6ecf3c8b385509cc4e0521d7e28d6eef1f70dc7ca0a29f26ec02344870c42
        command: ./runtest --clients 2 --verbose --tls
      cluster-test:
        type: cmd
        parent: make-build
        # Dockerfile for the builder img is in https://github.sc-corp.net/Snapchat/img/tree/master/build/ubuntu/ubuntu-20-04/keydb
        builder_image: us.gcr.io/snapchat-build-artifacts/prod/snapchat/img/build/keydb-ubuntu-20-04@sha256:c8e6ecf3c8b385509cc4e0521d7e28d6eef1f70dc7ca0a29f26ec02344870c42
        command: ./runtest-cluster --tls
      sentinel-test:
        type: cmd
        parent: make-build
        # Dockerfile for the builder img is in https://github.sc-corp.net/Snapchat/img/tree/master/build/ubuntu/ubuntu-20-04/keydb
        builder_image: us.gcr.io/snapchat-build-artifacts/prod/snapchat/img/build/keydb-ubuntu-20-04@sha256:c8e6ecf3c8b385509cc4e0521d7e28d6eef1f70dc7ca0a29f26ec02344870c42
        command: ./runtest-sentinel
      module-test:
        type: cmd
        parent: make-build
        # Dockerfile for the builder img is in https://github.sc-corp.net/Snapchat/img/tree/master/build/ubuntu/ubuntu-20-04/keydb
        builder_image: us.gcr.io/snapchat-build-artifacts/prod/snapchat/img/build/keydb-ubuntu-20-04@sha256:c8e6ecf3c8b385509cc4e0521d7e28d6eef1f70dc7ca0a29f26ec02344870c42
        command: ./runtest-moduleapi
      rotation-test:
        type: cmd
        parent: make-build
        # Dockerfile for the builder img is in https://github.sc-corp.net/Snapchat/img/tree/master/build/ubuntu/ubuntu-20-04/keydb
        builder_image: us.gcr.io/snapchat-build-artifacts/prod/snapchat/img/build/keydb-ubuntu-20-04@sha256:c8e6ecf3c8b385509cc4e0521d7e28d6eef1f70dc7ca0a29f26ec02344870c42
        command: ./runtest-rotation
